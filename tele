local teleporter = {}
root = teleporter

local TELE_DELAY = 1

INDEX = 0

local title = "Teleport Control"
local uis = {}
teleporter.uis=uis
local open = false

local cables = {
  admin = BUNDLE:new("bottom",colors.yellow,"AdminShortcut"),
  doors = BUNDLE:new("bottom",colors.magenta,"ChamberDoors"),
  piston = BUNDLE:new("bottom",colors.orange,"PistonDrop"),
  lights = BUNDLE:new("bottom",colors.white,"BackLights"),
  detector = BUNDLE:new("bottom",colors.lightBlue,"PlayerDetector")
  }


local function teleport()
  if open then
    ui:printCentered("Close teleport bay.",10)
    waitSeconds(1.5)
    ui:printCentered("                   ",10)
  else
    writeStatus("Teleporting...")
  end
end

local function detector()
  while true do
    local event = waitSignal("redstone")
    if event == "terminate" then return end
    if cables.detector:isOn() then
      cables.lights:enable()
    else
      cables.lights:disable()
    end
  end
end

local function doorMenu()
  if open then return "CLOSE Teleport Bay"
  else return "OPEN  Teleport Bay"
  end
end

local function testCable(cable)
  INDEX = INDEX + 1
  local v =  redstone.getBundledOutput(cable.side)
  writeStatus(INDEX .. " output: " .. v)
  --if v then
  --  writeStatus(INDEX .. " Cable is on!")
  --else
  --  writeStatus(INDEX .. " Cable is off.")
  --end
end

local function adminSignal()
  while true do
    local event = waitSignal("redstone")
    if event == "terminate" then return ok end
    if rs.testBundledInput(signals.admin.side,signals.admin.cable) then
      signal("teleport")
    end
  end
end

local function toggleDoors()
  if open then
    open = false
    cables.doors:disable()
  else
    open = true
    cables.doors:enable()
  end
end

local function exit()
  if ui:yesNo("Shutdown?") then
    ui:terminate()
    os.queueEvent("terminate")
    return "kill"
  end
end

local root = {
  doorMenu, toggleDoors,
  "Teleport", teleport,
  "Shutdown", exit
  }
      
teleporter.init = function()
  local ui = UI:aquireMonitor()
  table.insert(uis,ui)
  ui.clear()
  
  rs.setBundledOutput(cables.piston.side,0)
end
 
teleporter.main = function()
  local m = uis[1]:readMenu(root)
  m.setTitle(title)
  runProcess(m.cycle,"teleporter_menu")
  runProcess(detector,"teleDetector")
end
